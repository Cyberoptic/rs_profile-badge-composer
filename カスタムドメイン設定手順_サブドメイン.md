# カスタムドメイン設定手順（サブドメイン版）

## 📋 概要

既存のドメイン `helicalworks.biz` のサブドメインを使用して、Amplifyアプリにカスタムドメインを設定します。

### 設定するドメイン例
- `app.helicalworks.biz`
- `composer.helicalworks.biz`
- `badge.helicalworks.biz`

**推奨**: `app.helicalworks.biz` または `composer.helicalworks.biz`

---

## ⏱️ 所要時間

- **設定作業**: 10分
- **DNS反映待ち**: 5分～2時間（通常は10-30分）
- **SSL証明書発行**: 10-30分

**合計**: 約30分～3時間

---

## 🎯 作業の流れ

```
1. 既存のカスタムドメイン設定を削除
   ↓
2. 新しいサブドメインを追加（Amplify）
   ↓
3. CNAMEレコードを取得
   ↓
4. Route 53にCNAMEレコードを追加
   ↓
5. DNS反映とSSL証明書発行を待つ
   ↓
6. 完了確認
```

---

## 📝 事前準備

### 必要なもの
- ✅ AWSコンソールへのアクセス権
- ✅ Route 53の編集権限
- ✅ 約30分～3時間の時間

### 決めておくこと

**使用するサブドメイン名**を決めてください：

| サブドメイン | 用途例 | URL例 |
|------------|--------|-------|
| `app` | アプリケーション | `https://app.helicalworks.biz` |
| `composer` | Badge Composer | `https://composer.helicalworks.biz` |
| `badge` | バッジツール | `https://badge.helicalworks.biz` |
| `rs-pbc` | RS Profile Badge Composer | `https://rs-pbc.helicalworks.biz` |

**推奨**: `app` または `composer`（シンプルで覚えやすい）

---

## ステップ1: 既存のカスタムドメイン設定を削除

### 1-1. AWS Amplifyコンソールを開く

1. https://console.aws.amazon.com/ にログイン
2. 検索ボックスに **「Amplify」** と入力
3. **AWS Amplify** サービスを開く

### 1-2. アプリを選択

1. **rs_profile-badge-composer** をクリック

### 1-3. ドメイン管理を開く

1. 左サイドバーの **「ホスティング」** セクション
2. **「ドメイン管理」** をクリック

### 1-4. 既存のドメインを削除

#### 表示されているドメイン

```
カスタムドメイン: helicalworks.biz
ステータス: SSL を作成（失敗） ❌
```

#### 削除手順

1. `helicalworks.biz` の右側にある **「アクション」** ボタンをクリック
2. **「削除」** を選択
3. 確認ダイアログが表示されたら **「削除」** をクリック

💡 **この作業の意味**  
失敗した設定をクリーンアップして、新しい設定を始められる状態にします。

---

## ステップ2: 新しいサブドメインを追加

### 2-1. ドメインを追加

1. 「ドメイン管理」画面で **「ドメインを追加」** ボタンをクリック

### 2-2. ドメインを入力

#### 入力画面

```
┌─────────────────────────────────────────┐
│ ドメインの追加                           │
│                                          │
│ ドメイン *                               │
│ ┌─────────────────────────────────────┐ │
│ │ helicalworks.biz                    │ │
│ └─────────────────────────────────────┘ │
│                                          │
│ □ サブドメインを除外                     │
│                                          │
│ [キャンセル]  [ドメインを設定]          │
└─────────────────────────────────────────┘
```

#### 重要：ドメインの入力方法

**❌ 間違い**: `helicalworks.biz` と入力
**✅ 正しい**: そのまま次に進む（後でサブドメインを指定）

### 2-3. ドメインを設定をクリック

**「ドメインを設定」** ボタンをクリック

### 2-4. サブドメイン設定画面

次の画面で、以下が表示されます：

```
┌─────────────────────────────────────────────────┐
│ helicalworks.biz のサブドメイン設定              │
│                                                  │
│ サブドメイン        ブランチ        リダイレクト │
│ ┌─────────────┐  ┌────────┐   ┌────────────┐   │
│ │ www         │  │ main   │   │ ---        │   │
│ └─────────────┘  └────────┘   └────────────┘   │
│                                                  │
│ ┌─────────────┐  ┌────────┐   ┌────────────┐   │
│ │ (なし)       │  │ main   │   │ www へ     │   │
│ └─────────────┘  └────────┘   └────────────┘   │
│                                                  │
│ [サブドメインを追加]                             │
└─────────────────────────────────────────────────┘
```

### 2-5. サブドメインを編集

#### デフォルトの設定を削除または編集

1. **1行目の「www」を削除** または編集
   - 「www」の行の右端にある **「×」** をクリック
   
2. **新しいサブドメインを追加**
   - **「サブドメインを追加」** ボタンをクリック
   
3. **サブドメイン名を入力**
   ```
   サブドメイン: app          ← ここに選んだ名前を入力
   ブランチ: main
   リダイレクト: ---
   ```

#### 推奨設定

```
サブドメイン: app
ブランチ: main
リダイレクト: ---
```

または

```
サブドメイン: composer
ブランチ: main
リダイレクト: ---
```

### 2-6. 保存して続行

**「保存」** または **「次へ」** ボタンをクリック

---

## ステップ3: CNAMEレコードを取得

### 3-1. SSL証明書設定画面

次の画面が表示されます：

```
┌─────────────────────────────────────────────────┐
│ SSL証明書の設定                                  │
│                                                  │
│ AWS Certificate Managerで証明書を作成します     │
│                                                  │
│ 以下のCNAMEレコードをDNSプロバイダーに追加して   │
│ ドメインの所有権を確認してください：              │
│                                                  │
│ レコード名:                                      │
│ _xxxxxxxxxxxxxxxxxxxxx.app.helicalworks.biz     │
│                                                  │
│ レコード値:                                      │
│ _yyyyyyyyyyyyyyyyyyyyyy.acm-validations.aws.    │
│                                                  │
│ [コピー] [コピー]                                │
│                                                  │
│ また、以下のCNAMEレコードも追加してください：     │
│                                                  │
│ レコード名:                                      │
│ app.helicalworks.biz                            │
│                                                  │
│ レコード値:                                      │
│ xxxxxxxxxxxxx.cloudfront.net                    │
│                                                  │
│ [コピー] [コピー]                                │
└─────────────────────────────────────────────────┘
```

### 3-2. 必要な情報をメモ

以下の**4つの値**をメモ帳にコピーしてください：

#### ① SSL検証用CNAMEレコード名
```
_xxxxxxxxxxxxxxxxxxxxx.app.helicalworks.biz
```

#### ② SSL検証用CNAMEレコード値
```
_yyyyyyyyyyyyyyyyyyyyyy.acm-validations.aws.
```

#### ③ アプリアクセス用CNAMEレコード名
```
app.helicalworks.biz
```

#### ④ アプリアクセス用CNAMEレコード値
```
xxxxxxxxxxxxx.cloudfront.net
```

💡 **この画面は開いたままにしておいてください**

---

## ステップ4: Route 53にCNAMEレコードを追加

### 4-1. 新しいタブでRoute 53を開く

1. **新しいブラウザタブ**を開く
2. AWSコンソールの検索ボックスに **「Route 53」** と入力
3. **Route 53** サービスを開く

### 4-2. ホストゾーンを選択

1. 左サイドバーの **「ホストゾーン」** をクリック
2. **helicalworks.biz** をクリック

### 4-3. レコードを作成（1つ目：SSL検証用）

#### 手順

1. **「レコードを作成」** ボタンをクリック

2. **簡易作成**を選択（デフォルト）

3. 以下を入力：

   ```
   レコード名: _xxxxxxxxxxxxxxxxxxxxx.app
   （ステップ3-2の①から「.helicalworks.biz」を除いた部分）
   
   レコードタイプ: CNAME
   
   値: _yyyyyyyyyyyyyyyyyyyyyy.acm-validations.aws.
   （ステップ3-2の②）
   
   TTL: 300（デフォルト）
   
   ルーティングポリシー: シンプルルーティング（デフォルト）
   ```

4. **「レコードを作成」** ボタンをクリック

💡 **この作業の意味**  
AWSがあなたがこのドメインの所有者であることを確認するためのレコードです。

### 4-4. レコードを作成（2つ目：アプリアクセス用）

#### 手順

1. 再び **「レコードを作成」** ボタンをクリック

2. 以下を入力：

   ```
   レコード名: app
   （または選んだサブドメイン名）
   
   レコードタイプ: CNAME
   
   値: xxxxxxxxxxxxx.cloudfront.net
   （ステップ3-2の④）
   
   TTL: 300
   
   ルーティングポリシー: シンプルルーティング
   ```

3. **「レコードを作成」** ボタンをクリック

💡 **この作業の意味**  
`app.helicalworks.biz`にアクセスしたユーザーを、Amplifyアプリに転送するためのレコードです。

### 4-5. 作成完了を確認

Route 53の「レコード」画面に、以下の2つが表示されていればOK：

```
✅ _xxxxxxxxxxxxxxxxxxxxx.app.helicalworks.biz → CNAME → acm-validations.aws
✅ app.helicalworks.biz → CNAME → cloudfront.net
```

---

## ステップ5: Amplifyでドメイン追加を完了

### 5-1. Amplifyのタブに戻る

ステップ3-2で開いたままにしておいたAmplifyの画面に戻ります。

### 5-2. 完了ボタンをクリック

画面下部の **「保存」** または **「完了」** ボタンをクリック

### 5-3. ステータス確認

「ドメイン管理」画面に戻ります。

#### 表示される内容

```
カスタムドメイン: app.helicalworks.biz

サブドメイン            ブランチ    ステータス
─────────────────────────────────────────────
app.helicalworks.biz    main        ⏳ SSL を作成中...
```

---

## ステップ6: DNS反映とSSL証明書発行を待つ

### 6-1. 待機時間

以下の処理が自動的に実行されます：

| ステップ | 説明 | 所要時間 |
|---------|------|---------|
| **DNS反映** | Route 53のレコードがインターネット全体に反映 | 5分～2時間 |
| **ドメイン検証** | AWSがドメイン所有権を確認 | 5-10分 |
| **SSL証明書発行** | Let's Encryptから証明書を取得 | 10-30分 |

**通常は30分程度で完了します**

### 6-2. ステータスの変化

#### 進行中（10-30分）
```
⏳ SSL を作成中...
```

#### 完了（✅ 緑色）
```
✅ 使用可能
```

#### エラー（❌ 赤色）
```
❌ SSL を作成（失敗）
```

### 6-3. 進捗確認方法

1. Amplifyの「ドメイン管理」画面を **リロード**（F5キー）
2. 5分おきに確認
3. ステータスが **「使用可能」✅** になるまで待つ

💡 **コーヒーブレイク時間です** ☕

---

## ステップ7: 完了確認

### 7-1. ステータスが「使用可能」になったら

```
✅ 使用可能

サブドメイン            ブランチ    ステータス
─────────────────────────────────────────────
app.helicalworks.biz    main        ✅ 使用可能
```

### 7-2. ブラウザでアクセス

新しいタブを開いて、以下のURLにアクセス：

```
https://app.helicalworks.biz
```

（または選んだサブドメイン）

### 7-3. 動作確認チェックリスト

- [ ] 画面が表示される（ロードエラーなし）
- [ ] HTTPS接続（🔒 鍵マークが表示される）
- [ ] 「画像を追加」エリアが表示される
- [ ] ドラッグ&ドロップが動作する
- [ ] プレビューが表示される
- [ ] ダウンロードボタンが機能する

### 7-4. 🎉 完了！

すべてチェックが入ったら、カスタムドメイン設定完了です！

---

## 🆘 トラブルシューティング

### 問題1: 30分経ってもステータスが「SSL を作成中」のまま

#### 原因
- DNS反映が遅れている
- CNAMEレコードが間違っている

#### 解決方法

**A. DNS反映を確認**

ターミナル（コマンドプロンプト）で以下を実行：

```bash
# Windows
nslookup app.helicalworks.biz

# Mac/Linux
dig app.helicalworks.biz
```

**正常な場合の出力例：**
```
app.helicalworks.biz → xxxxxxxxxxxxx.cloudfront.net
```

**B. Route 53のレコードを再確認**

1. Route 53の「helicalworks.biz」ホストゾーンを開く
2. 以下の2つのレコードが存在するか確認：
   - `_xxxxxxxxxxxxxxxxxxxxx.app.helicalworks.biz` (CNAME)
   - `app.helicalworks.biz` (CNAME)
3. 値が正しいか確認

**C. もう少し待つ**

最大2時間までかかる場合があります。待ってから再確認してください。

---

### 問題2: ステータスが「SSL を作成（失敗）」になった

#### 原因
- CNAMEレコードが間違っている
- DNS反映がまだ完了していない

#### 解決方法

**A. CNAMEレコードを確認**

Route 53で以下を確認：

1. `app.helicalworks.biz` のCNAMEレコード値が正しいか
2. 値の末尾に「.」（ドット）が付いているか
   - ✅ 正しい: `xxxxxxxxxxxxx.cloudfront.net.`
   - ❌ 間違い: `xxxxxxxxxxxxx.cloudfront.net`（ドットなし）

**B. ドメインを再追加**

1. Amplifyの「ドメイン管理」で失敗したドメインを **削除**
2. 10分待つ
3. **ステップ2**から再度実行

**C. Amplifyサポートに問い合わせ**

上記でも解決しない場合は、AWSサポートに連絡してください。

---

### 問題3: 「このサイトにアクセスできません」エラー

#### 症状
```
このサイトにアクセスできません
app.helicalworks.biz のサーバーの IP アドレスが見つかりませんでした。
```

#### 原因
DNS反映がまだ完了していない

#### 解決方法

**A. DNS反映を待つ**

最大2時間待ってから再度アクセス

**B. DNSキャッシュをクリア**

**Windows:**
```bash
ipconfig /flushdns
```

**Mac:**
```bash
sudo dscacheutil -flushcache
sudo killall -HUP mDNSResponder
```

**C. 別のネットワークで試す**

- スマートフォンのテザリング
- 別のWi-Fiネットワーク
- モバイルデータ通信

---

### 問題4: SSL証明書エラー（🔒 鍵マークが表示されない）

#### 症状
```
この接続ではプライバシーが保護されません
NET::ERR_CERT_COMMON_NAME_INVALID
```

#### 原因
SSL証明書がまだ発行されていない

#### 解決方法

**A. Amplifyのステータスを確認**

「ドメイン管理」画面で **「使用可能」✅** になっているか確認

**B. ブラウザのキャッシュをクリア**

1. ブラウザの設定を開く
2. 「閲覧履歴を削除」
3. 「キャッシュされた画像とファイル」を選択
4. 削除して再度アクセス

**C. シークレットモード/プライベートブラウジングで試す**

---

## 📞 サポートが必要な場合

以下の情報をお知らせください：

1. **現在のステータス**（「SSL を作成中」など）
2. **経過時間**（設定してから何分経過したか）
3. **エラーメッセージ**（あれば）
4. **DNSレコードのスクリーンショット**（Route 53画面）
5. **Amplifyドメイン管理画面のスクリーンショット**

できる限りサポートいたします！

---

## 🎊 設定完了後

### 使用するURL

カスタムドメイン設定完了後は、以下のURLでアクセスできます：

```
https://app.helicalworks.biz
```

### 自動デプロイも有効

今後、GitHubの`main`ブランチにコードをプッシュすると：
1. AWS Amplifyが自動検知
2. 自動ビルド＆デプロイ
3. 約5-7分後に変更が反映
4. **カスタムドメインでも最新版にアクセス可能**

### URLの共有

以下のどちらでもアクセスできます：
- ✅ カスタムドメイン: `https://app.helicalworks.biz`
- ✅ Amplify自動URL: `https://main.d1a41gxcwteq.amplifyapp.com`

---

**最終更新：2025年10月16日**  
**対象アプリ：RS Profile Badge Composer v2.1**
